#!/usr/bin/env python
import sys
import os
import argparse
from pymongo import Connection

# Hack in case the python path is not set correctly
sys.path.append(os.path.dirname(
        os.path.abspath(sys.argv[0])) + os.sep + os.pardir + os.sep + "algolab")

from algolab.cmdutil import defaultparser
from algolab.stations import build_station_collection, \
                             build_station_collection_from_stations


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Station Graph Generation Tool",
                                     parents=[defaultparser()])
    parser.add_argument("-s", "--stations-file", type=str, default="data/Stations.txt",
                        help="path to station file (Stations.txt)")
    parser.add_argument("-r", "--routes-file", type=str, default="data/sgrv.csv",
                        help="path to routes file (sgrv.csv)")
    parser.add_argument("--base-collection", default="railway_graph",
                        dest="base", help="base collection")
    parser.add_argument("--target-collection", default="stations",
                        dest="target", help="target collection")
    parser.add_argument("--sync-with-routes", action="store_true", dest="sync",
                        help="only include stations that are mentioned in routes file")
    args = parser.parse_args()

    db = Connection(args.host, args.port)[args.db]
    base = db[args.base]
    target = db[args.target]

    if args.sync:
        build_station_collection(base, target, args.stations_file, args.routes_file)
    else:
        build_station_collection_from_stations(base, target, args.stations_file)
