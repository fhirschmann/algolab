#!/usr/bin/env python
import sys
import os

# Hack in order to avoid making this a python package
sys.path.append(os.path.dirname(
    os.path.abspath(sys.argv[0])) + os.sep + os.pardir + os.sep + "algolab")

import argparse
from pymongo import Connection
from pylab import *

from algolab.segment import ESSegmenter
from algolab.util import lonlat2xy


def visualize(segments, ptitle, count, saveto=False):
    subplots_adjust(left=0.15, bottom=0.25)

    axes().get_xaxis().set_visible(False)
    axes().get_yaxis().set_visible(False)

    for segment in segments:
        projection = [lonlat2xy(*p) for p in segment]
        plot(zip(*projection)[0], zip(*projection)[1], 'r-')

    draw()

    grid(True)
    title("%s (%s nodes)" % (ptitle, count))

    if saveto:
        savefig(saveto, dpi=120)
    else:
        show()


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Railway Graph Visualization")
    parser.add_argument("--host", action="store", dest="host", default="127.0.0.1",
            type=str, help="host of the mongo database")
    parser.add_argument("--port", action="store", dest="port", default=27017,
            type=int, help="port of the mongo database")
    parser.add_argument("--db", action="store", dest="db", default="osm-data",
            type=str, help="name of the database")
    parser.add_argument("-c", "--collection", action="store", dest="rg", default="railway_graph",
            type=str, help="name of the collection")
    parser.add_argument("-t", "--title", action="store", dest="title", default="RG Visualization",
            type=str, help="title of the image")
    parser.add_argument("-s", "--save", action="store", dest="saveto", default=None,
            type=str, help="save image to")
    args = parser.parse_args()

    rg = Connection(args.host, args.port)[args.db][args.rg]
    segments = ESSegmenter(rg).segments_as_coordinates

    visualize(segments, args.title + " [%s]" % args.rg, rg.count(), args.saveto)
